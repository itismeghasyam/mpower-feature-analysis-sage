###############################################################
#' Script to get synapse ids across data pipeline
#' utilizing Synapse File View Query
#' 
#' @author: aryton.tediarjo@sagebase.org
####################################################################

get_file_view_ref <- function(syn = NULL){
    template_path <- file.path("synapseformation/manuscript.yaml")
    if(is.null(syn)){
        project_id <- synapser::synFindEntityId(
            yaml::read_yaml(template_path)[[1]]$name)
        file_view_exists <- 
          !is.null(synapser::synFindEntityId("mPower2.0 - File View", project_id))
        if (file_view_exists) {
          file_view_id <- 
            synapser::synFindEntityId("mPower2.0 - File View", project_id)
        } else {
          file_view_id <- 
            synapser::synFindEntityId("mPower File View Directory", project_id)
        }
          
    }else{
        project_id <- syn$findEntityId(
            yaml::read_yaml(template_path)[[1]]$name)
        file_view_exists <- 
          !is.null(synapser::synFindEntityId("mPower2.0 - File View", project_id))
        if (file_view_exists) {
          file_view_id <- 
            syn$findEntityId("mPower2.0 - File View", project_id)
        } else {
          file_view_id <- 
            syn$findEntityId("mPower File View Directory", project_id)
        }
    }
    return(file_view_id)
}

get_feature_extraction_ids <- function(syn = NULL){
    if(is.null(syn)){
        file_view_id <- get_file_view_ref()
        data <- synapser::synTableQuery(
            glue::glue("SELECT * FROM {file_view_id}", 
                       file_view_id = file_view_id))$asDataFrame() %>%
            tibble::as_tibble()
    }else{
        file_view_id <- get_file_view_ref(syn)
        data <- syn$tableQuery(
            glue::glue("SELECT * FROM {file_view_id}", 
                       file_view_id = file_view_id))$asDataFrame() %>%
            tibble::as_tibble()
        
    }
    ref_list <- list()
    ref_list$parent_id <- data %>%
        dplyr::filter(
            type == "folder",
            name == "Features - Extracted") %>% .$id
    ref_list$demo <- data %>%
        dplyr::filter(
            analysisType == "demographics-v2",
            pipelineStep == "feature extraction") %>% .$id
    ref_list$tap_20_secs <- data %>%
        dplyr::filter(
            pipelineStep == "feature extraction",
            filter == "20 seconds cutoff",
            task == "tapping",
            analysisType == "tapping-v2") %>% .$id
    ref_list$tap <- data %>%
        dplyr::filter(
            is.na(filter),
            pipelineStep == "feature extraction",
            task == "tapping",
            analysisType == "tapping-v2") %>% .$id
    ref_list$tremor <- data %>%
        dplyr::filter(
            is.na(filter),
            pipelineStep == "feature extraction",
            task == "tremor",
            analysisType == "tremor-v2") %>% .$id
    ref_list$walk_7.5 <- data %>%
        dplyr::filter(
            filter == "7.5-seconds window",
            pipelineStep == "feature extraction",
            task == "walking",
            analysisType == "walk30secs-v2") %>% .$id
    ref_list$walk_5 <- data %>%
        dplyr::filter(
            filter == "5-seconds window",
            pipelineStep == "feature extraction",
            task == "walking",
            analysisType == "walk30secs-v2") %>% .$id
    ref_list$passive <- data %>%
        dplyr::filter(
            filter == "7.5-seconds window",
            pipelineStep == "feature extraction",
            task == "passive",
            analysisType == "passive-gait") %>% .$id
    return(ref_list)
}


get_feature_processed_ids <- function(syn = NULL){
    if(is.null(syn)){
        file_view_id <- get_file_view_ref()
        data <- synTableQuery(
            glue::glue("SELECT * FROM {file_view_id}", 
                       file_view_id = file_view_id))$asDataFrame() %>%
            tibble::as_tibble()
    }else{
        file_view_id <- get_file_view_ref(syn)
        data <- syn$tableQuery(
            glue::glue("SELECT * FROM {file_view_id}", 
                       file_view_id = file_view_id))$asDataFrame() %>%
            tibble::as_tibble()
        
    }
    ref_list <- list()
    ref_list$parent_id <- data %>%
        dplyr::filter(
            type == "folder",
            name == "Features - Processed") %>% .$id
    ref_list$tap_20_secs <- data %>%
        dplyr::filter(
            pipelineStep == "feature processing",
            filter == "20 seconds cutoff",
            task == "tapping",
            analysisType == "tapping-v2") %>% .$id
    ref_list$tap <- data %>%
        dplyr::filter(
            is.na(filter),
            pipelineStep == "feature processing",
            task == "tapping",
            analysisType == "tapping-v2") %>% .$id
    return(ref_list)
}